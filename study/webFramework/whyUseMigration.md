## 마이그레이션을 하는 이유

### 서버 환경
- 일반적으로 서버 환경은 로컬 환경, 검증 환경(= 개발서버), 프로덕션 환경으로 나뉜다.

#### 로컬환경
- 개인 컴퓨터에서 시스템의 코드를 개발하는 환경이다.
- 하나의 프로젝트에 여러명의 개발자가 참여하고 있다면, 각각의 개발자는 각각의 로컬 환경을 갖고 각자 담당하는 부분의 코드를 작성하게 된다.

#### 검증환경
- 로컬에서 작동된 코드가 제대로 동작하는지 시스템을 만드는 여러 관계자들이 확인을 하고 이상이 없는지 확인하는 서버이다.

#### 프로덕션 환경
- 개발한 코드가 고객들에게 서비스 되는 서버이다.
- 개발한 코드가 검증환경에서 동작의 이상이 없다고 시스템을 만드는 관계자들의 확인이 끝나면 프로덕션 환경에 적용된다.

### 로컬, 검증, 프로덕션 환경은 서로 다른 데이터베이스이다.
- 데이터베이스는 데이터를 저장하기 위해 사용하는 곳이다.
- 로컬, 검증, 프로덕션 환경의 데이터는 서로 다르다. 프로덕션 환경은 서비스를 이용하는 유저들이 생성하고 활동한 정보를 저장하며, 검증환경은 서비스의 동작을 체크하기 위해 생성한 테스트용 데이터를 저장한다. 로컬 환경은 개발자가 개발하면서 동작의 실행 여부를 확인하기 위한 데이터를 저장한다.
- 각 환경에서 저장되어야 하는 데이터가 다르다. 로컬 환경의 데이터가 검증 환경의 데이터와 섞이지 않게 하고, 검증 환경의 데이터가 프로덕션 환경의 데이터와 섞이지 않게 하기 위해서 저장되는 공간을 분리해야 한다. 따라서 서로 다른 데이터베이스를 사용하며 데이터가 저장되는 공간을 독립적으로 하며 데이터의 저장을 격리한다.
- 하지만, 로컬에서 개발된 사항은, 검증환경에 적용이 되고, 검증을 통과한 코드는 프로덕션 환경에 적용되기 때문에 로컬-검증-프로덕션 환경의 데이터베이스의 구성은 일치되는 것을 추구한다.

### 테이터베이스
- 데이터베이스는 테이블을 만드는 곳이다.
- 테이블에는 여러 컬럼이 존재하고 이 컬럼은 데이터의 특성을 기재한다.
- 테이블에는 데이터를 저장하고 이 데이터는 테이블에 정의한 컬럼에 해당하는 값을 갖는다.

#### 스키마
- 스키마는 데이터베이스의 구조를 의미한다. 데이터의 특성을 정의하기 위한 테이블의 테이블 및 컬럼 등의 구성을 의미한다.

### 마이그레이션
- 마이그레이션의 사전적인 의미는 '이주'이다.
- 마이그레이션이란 한 시스템의 구성과 데이터를 다른 곳으로 옮길 때 사용하는 개념이다. 이런 종류의 작업에 마이그레이션이라는 명칭을 붙인다.
- 윈도우 10을 사용하는 유저들에게 컴퓨터에 저장된 파일을 보존한채 윈도우 11로 옮기는 과정도 마이그레이션이라고 부른다.
- 데이터베이스 마이그레이션이란 개념도 있는데 하나의 데이터베이스의 스키마와 데이터를 다른 데이터베이스에 고스란히 옮기는 작업을 의미한다.

### 웹 프레임워크에서 마이그레이션
- 웹 프레임워크에서 마이그레이션은 데이터베이스의 스키마를 로컬환경, 검증환경, 프로덕션 환경에서 데이터베이스의 스키마를 동일하게 유지하기 위해 사용하는 개념이다.
- 개발 환경에서 데이터베이스의 구성을 변경을 하게 되면, 이름 검증환경에 적용하게 되고, 검증을 통과한 코드는 프로덕션 환경에 적용이 된다. 최종적으로는 로컬, 검증, 프로덕션 환경의 데이터베이스 구조를 일치시키려고 하는 것이다.
- 웹 프로그래밍은 주로 데이터베이스에서 데이터를 가져오는 기능을 중심으로 구성된다. 만약 동일한 코드에 서로 다른 구조의 스키마를 가지고 있는 데이터베이스를 이용한다면 한 쪽에서는 잘 동작하는 기능이더라도 다른 쪽에서는 코드에 맞는 데이터베이스 스키마가 구비되지 않아 에러가 발생할 수 있다. 따라서 한 쪽에서 동작하는 코드를 다른 쪽에서도 동작하도록 하기 위해서는 데이터베이스의 스키마를 일치시킬 필요성이 있다.
- 기본적으로 데이터베이스의 스키마는 쿼리로 정의한다. 로컬 환경에서 데이터베이스의 스키마를 변경시키기 위해서 사용한 쿼리는 그대로 검증환경에 동일하게 적용하여 로컬환경에서 개발한 스키마와 동일하게 검증환경에 적용해 주어야 한다. 그래야 개발한 코드의 동작이 검증 환경에서도 동일하게 동작할 것이기 때문이다. 또한 검증 환경을 통과했다면 로컬 환경과 검증환경에서 데이터베이스의 스키마 변경을 위해 사용한 쿼리는 그대로 프로덕션 환경에 적용 해 주어야 프로덕션 환경의 동작과 로컬 환경의 동작을 일치시킬 수 있다.
- 이렇게 로컬, 검증, 프로덕션 환경에서 동일한 데이터베이스 스키마를 가질 수 있도록 하기 위해서는 최종적인 스키마의 모습이 아니라, 스키마를 변경하기 위해 적용한 각각의 쿼리 모두를 기록해서 순차적으로 적용해야한다.

### 데이터베이스 관리 도구를 사용한 스키마 변경은 지양
- 데이터베이스를 다룰 때 MySQL Workbench, DataGrip, DBeaver, Oracle SQL Developer 등의 데이터 베이스 관리 도구를 사용한다. 이들 도구는 테이블의 스키마를 화면의 인터페이스를 통해서 쉽게 변경하는 기능을 제공한다. 하지만 이들 도구를 사용하게되면 쉽게 데이터베이스의 스키마를 변경할 수 있기 때문에 스키마 변경 기록을 남기지 않고 사용하게 되고 쿼리가 어떻게 변했는지 알 수 없게 되는 경우가 생긴다.
- 데이터베이스의 스키마의 변경이 한 번에 뚝딱 완성되는 것이 아니라 여러 번의 시행착오를 거쳐서 만들어지는 경우가 많다. 데이터베이스 관리 도구를 통해서 스키마를 변경하게 되면 쉽게 스키마를 변경할 수 있기 때문에 쿼리를 일일이 기록하지 않는 경우가 생기고 데이터베이스의 스키마가 어떻게 변경 되었는지 잊어버리는 경우가 생긴다.
- 로컬 환경에서 데이터베이스를 변경할 때 변경 사항이 빠짐없이 기록되지 않는다면, 검증 환경의 데이터베이스의 스키마를 변경할 때 동일하게 변경하지 못하는 경우가 생기고, 로컬 환경과 검증 환경 간의 스키마 불일치가 생기면 로컬 환경에서는 잘 동작하다가도 서버 환경에서는 동작하지 않는 경우가 생길 수 있다.
- 또한 스키마 불일치가 생겨서 검증환경에서 검증에 실패했다면, 누락된 스키마 변경 사항을 확인하기 위해 많은 시간을 써야 할 경우가 있으며, 검증을 통과하더라도 검증에서 누락된 스키마 변경 사항의 가능성 때문에 맘편히 프로덕션에 적용할 수 없는 경우가 생긴다.
- 또한 스키마 변경 기록을 일일이 남겨두더라도 코드를 적용할 때, 수동으로 데이터베이스 관리 도구 또는 직접 쿼리를 실행한다면 스키마 변경 쿼리를 적용하는 과정에서 휴먼 미스가 생길 수 있다.
- 따라서 데이터베이스의 스키마를 변경할 때는 데이터베이스 관리 도구를 이용해서 스키마를 변경하지 않고, 웹 프레임워크에서 제공하는 마이그레이션 툴을 사용해서 데이터베이스의 스키마 변경 사항을 빠짐없이 기록하면서 개발할 필요가 있다.

### 웹 프레임워크의 마이그레이션 도구를 사용
- 루비 온 레일즈를 비롯한 여러 웹 프레임워크들은 데이터베이스 마이그레이션이라는 기능을 지원한다. 웹 프레임워크에서 마이그레이션이란 것은 데이터베이스의 스키마를 정의할 수 있는 명령어들을 지원하고, 데이터베이스의 스키마를 변경하는 기능과 변경된 스키마를 다시 이전 상태로 되돌리는 롤백 기능을 제공한다.
- 로컬, 검증, 프로덕션 환경에서 데이터베이스의 스키마를 일치시키기 위해서는 로컬에서 작성한 스키마 변경 쿼리와 똑같은 쿼리를 검증 환경에 적용 해야 하고, 검증 환경에서 검증을 통과한 스키마 변경 쿼리와 똑같은 변경 쿼리를 프로덕션 환경의 데이터베이스에 적용해야 한다.
- 모든 스키마 변경은 웹 프레임워크에서의 마이그레이션을 도구를 사용하여 변경하여 스키마 변경사항에 누락되는 명령이 없도록 모든 스키마 변경 사항을 기록으로 남겨야 한다. 이렇게 스키마의 기록을 남기게 되면 로컬에서 개발한 마이그레이션을 그대로 검증 환경에 적용할 수 있고, 검증환경을 통과한 마이그레이션을 그대로 프로덕션에 적용하여 로컬, 검증, 프로덕션 환경의 일치를 추구하는 방향으로 개발을 한다. 
- 마이그레이션은 이전에 적용된 마이그레이션 기록을 갖고 있기 때문에 이전의 마이그레이션은 적용하지 않고 새롭게 만들어진 마이그레이션만 적용할 수 있는 기능을 가지고 있다. 따라서 스키마 변경을 위해 새로운 마이그레이션을 만들었고 이 마이그레이션으로 스키마를 변경한 것이 문제가 없다면, 검증환경에서 이 마이그레이션을 적용하면 이전에 적용된 마이그레이션은 적용되지 않고 새롭게 추가된 마이그레이션만 적용할 수 있다. 또한 검증 환경에서 문제가 없었다면 프로덕션 환경의 데이터베이스도 기존의 마이그레이션은 이미 적용되었기 때문에 적용되지 않고 새롭게 추가된 마이그레이션만 추가가 된다.

### 쿼리 기록을 순차적으로 적용해야 하는 이유
- 데이터베이스에 관한 지식이 없다면 왜 데이터베이스의 스키마를 변경하는 쿼리를 순차적으로 적용해야 하는지 의문을 가질 수 있다. 최종적으로 변경될 스키마를 그냥 동일하게 적용하면 되지 왜?라는 의문이 들 수 있다.
- 스키마를 변경하는 쿼리를 순차적으로 적용하는 이유는 데이터베이스에 들어 있는 데이터의 손실을 최대한 방지하기 위해서이다. 테이블을 지웠다가 새로 테이블을 생성하면 테이블에 저장되어 있던 데이터가 날아간다. 또한 컬럼을 지웠다가 새로 생성하면 컬럼에 저장되어 있던 데이터가 날아간다. 따라서 데이터의 손실이 일어나지 않는 방향으로 데이터베이스의 스키마를 순차적으로 수정해 나가야 한다.
- 또한 한 번에 너무 많은 변경 사항이 일어나면 어떤 변경이 일어났는지 명확하게 파악하기 어렵게 된다. 데이터베이스의 스키마 변경으로 인해서 서버의 동작에 문제가 발생하는 경우 순차적으로 실행된 마이그레이션에서 이전 상태의 마이그레이션으로 돌아가야 하는데 너무 많은 변경 사항이 생기면 마이그레이션 적용 이전 상황으로 돌아가기 위해서 잘 동작하는 다른 스키마의 변경도 다시 되돌려야 하는 상황이 생긴다. 따라서 마이그레이션은 순차적으로 점진적으로 적용하면서 문제 발생을 최소화 해야 한다.

### 마이그레이션의 특징
- 마이그레이션은 데이터베이스 변경을 명령할 수 있으며, 적용된 마이그레이션은 기록을 한다.
- 마이그레이션은 웹 프레임워크와 프로그래밍 언어에 따라 다양한 방식으로 사용되지만, 결국에는 쿼리라는 것으로 바뀌어서 데이터베이스에 전달된다. 이 쿼리는 데이터베이스의 스키마를 변경할 수도 있고 데이터베이스의 데이터를 추가 제거 변경할 수 있다.
- 마이그레이션은 프로그래밍 언어와 웹 프레임워크에서 제공하는 스키마 변경 명령들을 사용하지 않고, 스키마를 변경하는 쿼리를 직접 짜서 전달하는 것으로도 마이그레이션을 만들 수 있다. 하지만 마이그레이션이 되기 위해서는 데이터베이스의 스키마를 변경하는 기능 뿐만 아니라, 적용된 마이그레이션은 적용하지 않고, 적용되지 않은 마이그레이션은 적용되는 기능이 필요하다.

### 롤백이 필요한 이유
- 롤백이란 적용된 마이그레이션을 되돌리는 기능이다. 마이그레이션은 데이터베이스의 스키마를 변경하는 쿼리를 날리는 것이다. 스키마가 변경이 된 이후 다시 이전 스키마로 되돌아가기 위해서는 적용된 변경사항을 되돌리는 쿼리를 보내어 스키마를 변경해 줘야 한다. 데이터베이스는 데이터베이스의 스키마가 변경되었을 때 자동으로 그 이전 상태로 되돌아가는 기능을 제공하지 않는다. 따라서 이전 상태의 스키마로 되돌아가기 위해서는 변경 사항을 되돌리기 위한 쿼리를 데이터베이스에 보내어야 한다. 예를 들어 컬럼을 생성하는 마이그레이션을 실행했다면 이 컬럼을 삭제하는 마이그레이션을 만들어야 이전 상태로 되돌아 갈 수 있다.
- 라라벨과 같은 웹 프레임워크의 경우에는 롤백 기능을 위해서는 다시 되돌아가기 위해서 이전 상태로 되돌아가기 위한 마이그레이션 코드를 만들어주어야 하지만 루비의 경우에는 데이터베이스 변경을 위한 코드만 작성하면 따로 롤백을 위한 코드를 작성하지 않아도 롤백할 수 있는 기능을 일부 제공한다. 하지만 레일즈의 모든 마이그레이션이 롤백을 정의하지 않아도 되는 것은 아니다.
- 보통은 하나의 마이그레이션 단위에 스키마를 변경하는 코드와 변경된 스키마를 롤백하는 코드를 함께 작성하여 스키마 변경 사항에 대해 확실하게 이전 스키마로 되돌아갈 수 있는 책임을 지는 롤백 코드를 짜도록 한다.

#### 마이그레이션 재정의를 통해서 코드 다듬기
- 프로그래밍을 하면서 한 번에 요구사항을 충족하는 데이터베이스 스키마를 만들기는 쉽지 않다. 이렇게 변경해 보고 저렇게 변경해 보면서 요구사항에 적절한 스키마를 만들어 나간다. 따라서 작성한 스키마를 되돌리고 다시 만들고자 하는 경우가 빈번하게 생기게 된다. 이렇게 개발 환경에서 사용하는 마이그레이션을 재정의 하기 위해서 롤백 기능을 사용한다.
- 마이그레이션을 작성할 때는 모든 변경 사항을 기록한다고 하였다. 롤백을 하고 재정의 하는 것은 변경 사항을 기록하지 않는 것이다. 코드를 작성할 때는 불필요한 코드를 작성하지 않는 편이 좋다. 자유롭게 롤백을 할 수 있다면 롤백을 하고 마이그레이션을 재정의 하여 마이그레이션 코드에 필요한 것만 남겨서 깔끔하게 만드는 것이 좋다.
- 일반적으로 롤백을 하지 않는 이유는 데이터의 소실이 일어날 가능성이 높기 때문이다. 일반적으로 마이그레이션은 새로운 기능을 추가히기 위해 작성을 하고, 롤백은 새로운 기능의 추가를 위해 변경한 스키마의 변경이 잘못된 동작을 일으키는 경우 롤백을 하게 된다. 따라서 마이그레이션을 통해서 스키마를 변경 추가하게 되고 이 변경 추가 된 스키마에 맞게 시스템이 운영되면서 데이터가 추가된다. 그런데 롤백을 하게 되면 운영하면서 생성된 데이터가 사라지는 경우가 많다. 따라서 프로덕션 환경에서 롤백을 잘못 실행하게 되면 쌓아 놓은 데이터의 손실이 일어날 수 있기 때문에 롤백을 권하지 않는다. 하지만 로컬 환경은 데이터가 지워져도 크게 문제가 되지 않기 때문에 자유롭게 롤백을 해도 되고, 검증환경도 데이터가 손실되어도 큰 문제가 아닌 경우가 많기 때문에 경우에 따라 롤백을 사용해도 되는 경우가 잦다.
- 로컬 환경에서는 개발하다가 데이터베이스의 스키마가 이상하게 정의되었다면 자유롭게 롤백을 실행하여 마이그레이션 파일의 코드를 잘 다듬도록 하자.
